/*! arenajs - v0.1.0 - 2014-11-26
* https://github.com/jnylin/arena
* Copyright (c) 2014 Jakob Nylin; Licensed GPL */
function CatalogueRecord(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=new RegExp("[0-9]{4}","i");switch(this.view=b,b){case"detail":c="detail",d=new DetailViewMethods(this);break;case"list":c="record",d=new ListViewMethods(this)}switch(console.log("methodOnThisView = "),console.log(d),this.element=a,this.subElements={title:$(".arena-"+c+"-title span:not(.arena-result-item-number)",this.element),originalTitle:$(".arena-detail-original .arena-value",this.element),author:$(".arena-"+c+"-author .arena-value",this.element),publisher:$(".arena-record-publisher .arena-value",this.element),year:$(".arena-"+c+"-year .arena-value",this.element),isbns:$(".arena-"+c+"-isbn .arena-value",this.element),media:$(".arena-"+c+"-media .arena-value",this.element),lang:$(".arena-"+c+"-language .arena-value",this.element),cover:$(".arena-"+c+"-cover",this.element),bookJacket:$(".arena-book-jacket",this.element)},e=this.subElements.title.text().trim(),g=this.subElements.author.text(),h=this.subElements.publisher.text(),i=this.subElements.year.text(),l=this.subElements.media.text(),m=this.subElements.lang.text().trim(),c){case"record":j=this.subElements.isbns.text().split(", ");break;case"detail":j=[],$(this.subElements.isbns).each(function(){j.push($(this).text().trim())})}if(j)for(var o=0;o<j.length;o++){var p=j[o].replace(/-/g,"");if(13===p.length){k=p;break}}this.title=new Title(e,f),g&&(this.author={inverted:this.subElements.author.text(),lastname:this.subElements.author.text().split(",")[0].trim(),firstname:this.subElements.author.text().split(",")[1].substring(1).trim()}),h&&(this.publisher=h),i&&(this.year=n.exec(i)),l&&(this.media=l),m&&(this.lang=m),k&&(this.isbn=k),this.methodsOnThisView=d,this.getSelector=function(){return c},console.log(this)}function DetailViewMethods(a){try{if("detail"!==a.view)throw"Only possible from the detail-view"}catch(b){console.log(b)}}function ListViewMethods(a){try{if("list"!==a.view)throw"Only possible from the list-view"}catch(b){console.log(b)}this.record=a}function Ljudprov(a){$.ajax({type:"GET",url:"http://pipes.yahoo.com/pipes/pipe.run?_id=21ebd265e688111bc604d76d2bfb2841&_render=json&author="+a.author.lastname+"&title="+a.title.main+"&_callback=?",dataType:"jsonp",cache:!0,success:function(b){if(1===b.count&&"1"===b.value.items[0].hit){var c="http://www.elib.se/sample_new/audio/ISBN"+convert13to10(b.value.items[0].isbn)+".mp3";switch(a.view){case"detail":a.methodsOnThisView.addAudioPlayer(c,"Provlyssna","Lyssna på inledningen av boken");break;case"list":a.methodsOnThisView.advertise("Provlyssna")}}}})}function SearchResult(a){this.init(a),Wicket.Ajax.registerPostCallHandler(function(){this.init(a)})}function Smakprov(a){var b=this;$.getJSON("/smakprov/v1/records?isbn="+a.isbn,b.callback(this,a.view)),this.getCatalogueRecord=function(){return a}}function Title(a,b){var c,d,e,f,g,h,i;g=a,b=b||g,c=g.search("\\["),d=g.search(" :"),e=g.search("/"),f=g.search("\\[?(P\\.|Season|Series)"),d>-1&&(d+=1),e>-1&&(e+=2),h="",d>-1&&(d+=2,h=e>-1?g.substr(d,e-d-3):f>-1?g.substr(d,f-d-1):g.substr(d),h=h.replace(/[\[\]]/g,"")),i="",f>-1&&(a=g.substr(f),console.log(a),i=a.substr(a.search(/[0-9]/)),i=i.replace("]",""),a="",-1===i&&(i="")),c===f&&(c=-1),c>-1&&e>c?g=g.substr(0,c-1):d>-1&&(-1===e||e>d)?g=g.substr(0,d-3):e>-1?g=g.substr(0,e-3):f>-1&&(g=g.substr(0,f-1)),this.main=g,""!==h&&(this.sub=h),this.original=b,""!==i&&(this.part=i)}function convert10to13(a){var b,c="978",d=c.concat(a.substr(0,9)),e=d.split(""),f=0,g=0;for(f=0;f<e.length;f++){var h=3;f%2===0&&(h=1,g+=e[f]*h)}return b=10-g%10,d+b}function convert13to10(a){var b,c=a.substr(3,9),d=c.split(""),e=0,f=10,g=0;for(e=0;e<d.length;e++,f--)g+=d[e]*f;return b=11-g%11,11===b&&(b=0),10===b&&(b="X"),c+b}function truncate(a,b,c){if("undefined"==typeof b&&(b=100),"undefined"==typeof c&&(c="[...]"),a.length<b)return a;for(var d=b-1;" "!==a.charAt(d);d--)b--;return a.substr(0,b)+c}CatalogueRecord.prototype.hideField=function(a){$(".arena-"+this.getSelector()+"-"+a).hide()},CatalogueRecord.prototype.removeMediumFromTitle=function(){var a=this.subElements.title;a.text(a.text().replace(/\[.*\] ([\/:])/,"$1"))},CatalogueRecord.prototype.truncateTitle=function(){var a=this.title.main;this.title.part&&(a+=" "+this.title.part),this.subElements.title.html(truncate(a,30))},CatalogueRecord.prototype.ljudprov=function(){new Ljudprov(this)},CatalogueRecord.prototype.smakprov=function(){new Smakprov(this)},DetailViewMethods.prototype.addAudioPlayer=function(a,b,c){$("#audioplayer").jPlayer({ready:function(){$(this).jPlayer("setMedia",{mp3:a})},swfPath:"http://bibliotek.vimmerby.se/documents/58068/137602/Jplayer.swf/82ba0888-e101-438a-a73b-92f31bdc5f74"}),this.addLnkToExtRes("#jp_container_1",b,c,"_self","btnPlay"),$(".btnPlay").click(function(){$("#audioplayer").jPlayer("play"),$("#jp_container_1").show("slow")})},DetailViewMethods.prototype.addLnkToExtRes=function(a,b,c,d,e){var f=document.createElement("a");f.setAttribute("href",a),c?f.setAttribute("title",c):c="",d?f.setAttribute("target",d):(f.setAttribute("target","_blank"),f.setAttribute("title",c+" (Öppnas i nytt fönster)")),e&&f.setAttribute("class",e),f.innerHTML=b,$("#extRes").append(f)},ListViewMethods.prototype.advertise=function(a){var b=this.record.subElements.cover.find("a");0===b.find("ul.values").length&&b.append('<ul class="values"></ul>'),b.find("ul.values").append("<li>"+a+"</li>")},SearchResult.prototype.init=function(a){a.find(".arena-library-record").each(function(){var a=new CatalogueRecord(this,"list");a.truncateTitle(),a.isbn&&(a.hideField("isbn"),"Bok"===a.media&&a.smakprov())})},Smakprov.prototype.callback=function(a,b){return function(c){if(c.length>0)switch(b){case"detail":a.getCatalogueRecord().methodsOnThisView.addLnkToExtRes(a.getUrl(),"Smakprov","Läs ett smakprov av boken","_blank","btnRead");break;case"list":a.getCatalogueRecord().methodsOnThisView.advertise("Smakprov")}}},Smakprov.prototype.getUrl=function(){return"http://www.smakprov.se/smakprov.php?isbn="+this.getCatalogueRecord().isbn+"&l=vimmerby"};