/*! arenajs - v0.1.0 - 2014-12-03
* https://github.com/jnylin/arena
* Copyright (c) 2014 Jakob Nylin; Licensed GPL */
function CatalogueRecord(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=new RegExp("[0-9]{4}","i");switch(this.view=b,b){case"detail":c="detail",d=new DetailViewMethods(this);break;case"list":c="record",d=new ListViewMethods(this)}switch(this.element=a,this.subElements={title:$(".arena-"+c+"-title span:not(.arena-result-item-number)",this.element),originalTitle:$(".arena-detail-original .arena-value",this.element),author:$(".arena-"+c+"-author .arena-value",this.element),publisher:$(".arena-record-publisher .arena-value",this.element),year:$(".arena-"+c+"-year .arena-value",this.element),isbns:$(".arena-"+c+"-isbn .arena-value",this.element),media:$(".arena-"+c+"-media .arena-value",this.element),lang:$(".arena-"+c+"-language .arena-value",this.element),cover:$(".arena-"+c+"-cover",this.element),bookJacket:$(".arena-book-jacket",this.element)},e=this.subElements.title.text().trim(),g=this.subElements.author.text(),h=this.subElements.publisher.text(),i=this.subElements.year.text(),l=this.subElements.media.text().trim(),m=this.subElements.lang.text().trim(),c){case"record":j=this.subElements.isbns.text().split(", ");break;case"detail":j=[],$(this.subElements.isbns).each(function(){j.push($(this).text().trim())})}if(j)for(var o=0;o<j.length;o++){var p=j[o].replace(/-/g,"");if(13===p.length){k=p;break}}this.title=new Title(e,f),g&&(this.author={inverted:this.subElements.author.text(),lastname:this.subElements.author.text().split(",")[0].trim(),firstname:this.subElements.author.text().split(",")[1].substring(1).trim()}),h&&(this.publisher=h),i&&(this.year=n.exec(i)),l&&(this.media=l),m&&(this.lang=m),k&&(this.isbn=k),this.methodsOnThisView=d,this.getSelector=function(){return c},console.log(this)}function DetailViewMethods(a){try{if("detail"!==a.view)throw"Only possible from the detail-view"}catch(b){console.log(b)}}function Dvd(a){this.record=a;var b,c=new Tmdb("de9f79bfc08b502862e4d8bba5723414",this);b=a.title.main,a.title.sub&&(b+=" "+a.title.sub),console.log(c),c.search(b)}function ListViewMethods(a){try{if("list"!==a.view)throw"Only possible from the list-view"}catch(b){console.log(b)}this.record=a}function Ljudprov(a){$.ajax({type:"GET",url:"http://pipes.yahoo.com/pipes/pipe.run?_id=21ebd265e688111bc604d76d2bfb2841&_render=json&author="+a.author.lastname+"&title="+a.title.main+"&_callback=?",dataType:"jsonp",cache:!0,success:function(b){if(1===b.count&&"1"===b.value.items[0].hit){var c="http://www.elib.se/sample_new/audio/ISBN"+convert13to10(b.value.items[0].isbn)+".mp3";switch(a.view){case"detail":a.methodsOnThisView.addAudioPlayer(c,"Provlyssna","Lyssna på inledningen av boken");break;case"list":a.methodsOnThisView.advertise("Provlyssna")}}}})}function SearchResult(a,b){var c=$.extend(this.settings,b);this.init(a,c)}function Smakprov(a){var b=this;$.getJSON("/smakprov/v1/records?isbn="+a.isbn,b.callback(this,a.view)),this.getCatalogueRecord=function(){return a}}function Title(a,b){var c,d,e,f,g,h,i;g=a,b=b||g,c=g.search("\\["),d=g.search(" :"),e=g.search("/"),f=g.search("\\[?(P\\.|Season|Series)"),d>-1&&(d+=1),e>-1&&(e+=2),h="",d>-1&&(d+=2,h=e>-1?g.substr(d,e-d-3):f>-1?g.substr(d,f-d-1):g.substr(d),h=h.replace(/[\[\]]/g,"")),i="",f>-1&&(a=g.substr(f),console.log(a),i=a.substr(a.search(/[0-9]/)),i=i.replace("]",""),a="",-1===i&&(i="")),c===f&&(c=-1),c>-1&&e>c?g=g.substr(0,c-1):d>-1&&(-1===e||e>d)?g=g.substr(0,d-3):e>-1?g=g.substr(0,e-3):f>-1&&(g=g.substr(0,f-1)),this.main=g,""!==h&&(this.sub=h),this.original=b,""!==i&&(this.part=i)}function Tmdb(a,b){this.apiKey=a,this.dvd=b}function convert10to13(a){var b,c="978",d=c.concat(a.substr(0,9)),e=d.split(""),f=0,g=0;for(f=0;f<e.length;f++){var h=3;f%2===0&&(h=1,g+=e[f]*h)}return b=10-g%10,d+b}function convert13to10(a){var b,c=a.substr(3,9),d=c.split(""),e=0,f=10,g=0;for(e=0;e<d.length;e++,f--)g+=d[e]*f;return b=11-g%11,11===b&&(b=0),10===b&&(b="X"),c+b}function truncate(a,b,c){if("undefined"==typeof b&&(b=100),"undefined"==typeof c&&(c="[...]"),a.length<b)return a;for(var d=b-1;" "!==a.charAt(d);d--)b--;return a.substr(0,b)+c}CatalogueRecord.prototype.fieldIsVisible=function(a){return $(this.element).find(".arena-"+this.getSelector()+"-"+a).is(":visible")},CatalogueRecord.prototype.hideField=function(a){$(this.element).find(".arena-"+this.getSelector()+"-"+a).hide()},CatalogueRecord.prototype.removeMediumFromTitle=function(){var a=this.subElements.title;a.text(a.text().replace(/\[.*\] ([\/:])/,"$1"))},CatalogueRecord.prototype.trimTitle=function(){this.subElements.title.html(this.title.main)},CatalogueRecord.prototype.truncateTitle=function(){var a=this.title.main;this.title.part&&(a+=" "+this.title.part),this.subElements.title.html(truncate(a,30))},CatalogueRecord.prototype.dvd=function(){new Dvd(this)},CatalogueRecord.prototype.ljudprov=function(){new Ljudprov(this)},CatalogueRecord.prototype.smakprov=function(){new Smakprov(this)},DetailViewMethods.prototype.addAudioPlayer=function(a,b,c){$("#audioplayer").jPlayer({ready:function(){$(this).jPlayer("setMedia",{mp3:a})},swfPath:"http://bibliotek.vimmerby.se/documents/58068/137602/Jplayer.swf/82ba0888-e101-438a-a73b-92f31bdc5f74"}),this.addLnkToExtRes("#jp_container_1",b,c,"_self","btnPlay"),$(".btnPlay").click(function(){$("#audioplayer").jPlayer("play"),$("#jp_container_1").show("slow")})},DetailViewMethods.prototype.addLnkToExtRes=function(a,b,c,d,e){var f=document.createElement("a");f.setAttribute("href",a),c?f.setAttribute("title",c):c="",d?f.setAttribute("target",d):(f.setAttribute("target","_blank"),f.setAttribute("title",c+" (Öppnas i nytt fönster)")),e&&f.setAttribute("class",e),f.innerHTML=b,$("#extRes").append(f)},DetailViewMethods.prototype.addYoutubeMovie=function(a){console.log("addYoutubeMovie-id: "+a);var b="http://www.youtube-nocookie.com/embed/",c="560",d="315";$("#youtube").prepend('<iframe width="'+c+'" height="'+d+'" src="'+b+a+'?rel=0" frameborder="0" allowfullscreen></iframe>'),$("#youtube").show()},Dvd.prototype.cover=function(a){this.record.subElements.bookJacket.find("img").attr("src",a.urlPoster),"detail"===this.record.view&&this.record.subElements.cover.append('<a href="'+a.url+"/"+a.mediaType+"/"+a.id+'?language=sv" target="_blank" title="Information hos TMDb"><img src="http://bibliotek.vimmerby.se/'+a.pathLogo+'" alt="themoviedb.org" /></a>')},ListViewMethods.prototype.advertise=function(a){var b=this.record.subElements.cover.find("a");0===b.find("ul.values").length&&b.append('<ul class="values"></ul>'),b.find("ul.values").append("<li>"+a+"</li>")},SearchResult.prototype.init=function(a,b){a.find(".arena-library-record").each(function(){var a=new CatalogueRecord(this,"list");b.trimTitle&&a.trimTitle(),b.truncate&&a.truncateTitle(),a.isbn&&a.fieldIsVisible("isbn")&&(a.hideField("isbn"),a.smakprov()),"DVD"===a.media&&a.fieldIsVisible("media")&&a.dvd(),$.each(b.hideFields,function(b,c){a.hideField(c)})})},SearchResult.prototype.settings={trimTitle:!0,truncate:!1,hideFields:[]},Smakprov.prototype.callback=function(a,b){return function(c){if(c.length>0)switch(b){case"detail":a.getCatalogueRecord().methodsOnThisView.addLnkToExtRes(a.getUrl(),"Smakprov","Läs ett smakprov av boken","_blank","btnRead");break;case"list":a.getCatalogueRecord().methodsOnThisView.advertise("Smakprov")}}},Smakprov.prototype.getUrl=function(){return"http://www.smakprov.se/smakprov.php?isbn="+this.getCatalogueRecord().isbn+"&l=vimmerby"},Tmdb.prototype.url="http://www.themoviedb.org",Tmdb.prototype.api="http://api.themoviedb.org/3/",Tmdb.prototype.pathLogo="/documents/58068/140667/tmdb.png/fa3903c1-b170-4ab2-970a-baf9264001d9?t=1387215209438",Tmdb.prototype.baseUrlImg="http://image.tmdb.org/t/p/w",Tmdb.prototype.posterSizes=[92,154,185,342,500,780],Tmdb.prototype.search=function(a){console.log(this),console.log("query = "+a);var b=this.api+"search/multi?api_key="+this.apiKey+"&query="+encodeURIComponent(a)+"&language=sv";console.log("url = "+b),$.ajax({type:"GET",url:this.api+"search/multi?api_key="+this.apiKey+"&query="+encodeURIComponent(a)+"&language=sv",datatype:"jsonp",success:this.searchCallback(this),complete:function(a,b){console.dir(a),console.log("textStatus = "+b)}})},Tmdb.prototype.searchCallback=function(a){return function(b){for(var c,d,e,f=b.results,g=[],h=0;h<f.length;h++)"movie"===f[h].media_type&&a.movieIsInListOfHits(f[h],"ti")===!0?(c=f[h],e=a.dvd.record.year-REG_EXP_YEAR.exec(c.release_date),g.push([e,h])):"tv"===f[h].media_type&&a.tvIsInListOfHits(f[h])&&(d=f[h]);if(g.length<1)for(h=0;h<f.length;h++)"movie"===f[h].media_type&&a.movieIsProbablyInListOfHits(f[h])===!0&&(c=f[h],e=a.dvd.record.year-REG_EXP_YEAR.exec(c.release_date),g.push([e,h]));g.length<1?c="":(g.sort(function(a,b){return a[0]<b[0]?-1:a[0]>b[0]?1:0}),c=f[g[0][1]]),""!==c?(a.id=c.id,a.mediaType="movie",a.setUrlPoster(c.poster_path),a.trailer()):d&&(a.id=d.id,a.mediaType="tv",a.setUrlPoster(d.poster_path),a.tv(d.id)),console.log("Resultat av search"),console.log(a),f.length=0,a.dvd.cover(a)}},Tmdb.prototype.trailer=function(a){"undefined"==typeof a&&(a="sv"),$.ajax({type:"GET",url:this.api+"movie/"+this.id+"/trailers?api_key="+this.apiKey+"&language="+a,dataType:"jsonp",success:this.trailerCallback(this,a)})},Tmdb.prototype.trailerCallback=function(a,b){return function(c){var d;if(c.youtube.length>0&&(d=c.youtube[0].source),"undefined"==typeof d&&"sv"===b)a.trailer("en");else if(d)switch(a.dvd.record.view){case"detail":a.dvd.record.methodsOnThisView.addYoutubeMovie(d);break;case"list":a.dvd.record.methodsOnThisView.advertise("Trailer")}}},Tmdb.prototype.tv=function(a){$.ajax({type:"GET",url:this.api+"tv/"+a+"?api_key="+this.apiKey+"&language=sv",datatype:"jsonp",success:this.tvCallback(this,this.dvd.record.title.part)})},Tmdb.prototype.tvCallback=function(a,b){return function(c){var d;c.seasons.length===c.number_of_seasons&&(b-=1),d=c.seasons[b],a.setUrlPoster(d.poster_path),a.dvd.cover(a)}},Tmdb.prototype.movieIsInListOfHits=function(a){var b=!1,c=this.titleToCompare(this.dvd.record.title.main)===this.titleToCompare(a.title)||this.titleToCompare(this.dvd.record.title.main)===this.titleToCompare(a.original_title);return c&&(b=!0),b},Tmdb.prototype.movieIsProbablyInListOfHits=function(a){var b=!1,c=this.titleToCompare(a.title);return(c.search(this.titleToCompare(this.dvd.record.title.main))>-1&&c.search(this.dvd.record.title.part)>-1||this.titleToCompare(this.dvd.record.title.main).search(c)>-1)&&(b=!0),b},Tmdb.prototype.tvIsInListOfHits=function(a){var b=!1,c=this.titleToCompare(this.dvd.record.title.main)===this.titleToCompare(a.name);return c&&(b=!0),b},Tmdb.prototype.titleToCompare=function(a){var b,c;return b=new RegExp(/[&+,\/:;=?@"-]/g),c=a.toLowerCase(),c=c.replace(b,""),c=c.replace(/ /g,"")},Tmdb.prototype.getYoutubeId=function(a){var b="";return a.youtube.length>=1&&(b=a.youtube[0].source),b},Tmdb.prototype.setUrlPoster=function(a){a&&(this.urlPoster=this.baseUrlImg+this.posterSizes[0]+a)},window.REG_EXP_YEAR=new RegExp("[0-9]{4}","i");